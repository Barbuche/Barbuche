<!DOCTYPE html>
<html lang="ar" dir="rtl" id="htmlElement">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title> Tunisian Barber</title></title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --toast-success: #4CAF50;
      --toast-error: #f44336;
      --toast-info: #2196F3;
      --primary-color: #1a1a1a;
      --secondary-color: #d4aa70;
      --transition: all 0.3s ease;
      --waiting-bg: #cce5ff;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      max-width: 350px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      display: flex;
      align-items: center;
      transform: translateX(120%);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      font-size: 14px;
      line-height: 1.4;
    }

    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }

    .toast.success {
      background-color: var(--toast-success);
      border-left: 5px solid #2E7D32;
    }

    .toast.error {
      background-color: var(--toast-error);
      border-left: 5px solid #C62828;
    }

    .toast.info {
      background-color: var(--toast-info);
      border-left: 5px solid #1565C0;
    }

    .toast-icon {
      margin-right: 12px;
      font-size: 20px;
    }

    .toast-close {
      background: none;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
      margin-left: 15px;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .toast-close:hover {
      opacity: 1;
    }

    @media (max-width: 768px) {
      .toast {
        max-width: calc(100% - 40px);
      }
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: #fff;
      padding: 2rem;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      text-align: center;
      position: relative;
    }

    .modal-content h2 {
      font-size: clamp(18px, 4vw, 24px);
      color: #2c3e50;
      margin-bottom: 1.5rem;
      font-family: 'Poppins', sans-serif;
    }

    .modal-content .form-group {
      margin-bottom: 1.5rem;
    }

    .modal-content label {
      display: block;
      font-size: clamp(14px, 3vw, 16px);
      color: #34495e;
      margin-bottom: 0.5rem;
    }

    .modal-content input {
      width: 100%;
      padding: 0.8rem;
      font-size: clamp(14px, 3vw, 16px);
      border: 1px solid #bdc3c7;
      border-radius: 5px;
      box-sizing: border-box;
    }

    .modal-content button {
      padding: 0.8rem 1.5rem;
      background: #d4a373;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: clamp(14px, 3vw, 16px);
      transition: background 0.3s ease;
    }

    .modal-content button:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
    }

    .time-modal-content {
      padding: 1.5rem;
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
    }

    .time-buttons {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1.2rem;
    }

    .time-buttons button {
      width: 45%;
      padding: 0.6rem;
      font-size: clamp(12px, 2.5vw, 16px);
      background: #bdc3c7;
      color: #34495e;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .time-buttons button.selected {
      background: #d4a373;
      color: #fff;
    }

    #timeSelect {
      width: 100%;
      padding: 0.8rem;
      font-size: clamp(12px, 2.5vw, 16px);
      border: 1px solid #bdc3c7;
      border-radius: 5px;
      background: #fff;
      box-sizing: border-box;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    #confirmTimeButton {
      background: #2ecc71;
      margin-top: 1.2rem;
    }

    #confirmTimeButton:hover {
      background: #27ae60;
    }

    #timePlaceholder {
      width: 100%;
      padding: 0.8rem;
      font-size: clamp(12px, 2.5vw, 16px);
      border: 1px solid #bdc3c7;
      border-radius: 5px;
      background: #fff;
      cursor: pointer;
      text-align: center;
      color: #7f8c8d;
      transition: border-color 0.3s ease;
    }

    #timePlaceholder:hover {
      border-color: #d4a373;
    }

    .phone-input-wrapper {
      position: relative;
    }

    .phone-prefix {
      position: absolute;
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      pointer-events: none;
    }

    .phone-prefix img {
      width: 20px;
      height: 15px;
      margin-left: 5px;
    }

    .phone-prefix span {
      color: #34495e;
      font-size: clamp(14px, 3vw, 16px);
    }

    .phone-input-wrapper input {
      padding-right: 70px;
    }

    .waiting-list {
      padding: 100px 0;
      background-color: var(--waiting-bg);
      display: none;
    }

    .waiting-list-content {
      max-width: 600px;
      margin: 0 auto;
      background-color: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 600px) {
      .time-modal-content {
        width: 85%;
        max-width: 300px;
        padding: 1rem;
      }

      .time-buttons button {
        font-size: clamp(10px, 2vw, 14px);
        padding: 0.5rem;
      }

      .waiting-list {
        padding: 50px 0;
      }

      .waiting-list-content {
        padding: 20px;
      }

      #timeSelect {
        font-size: clamp(10px, 2vw, 14px);
        padding: 0.6rem;
      }

      #confirmTimeButton {
        padding: 0.6rem 1rem;
        font-size: clamp(10px, 2vw, 14px);
      }

      .phone-prefix img {
        width: 16px;
        height: 12px;
      }

      .phone-prefix span {
        font-size: clamp(12px, 2vw, 14px);
      }

      .phone-input-wrapper input {
        padding-right: 60px;
      }
    }

    @media (min-width: 601px) {
      html[dir="ltr"] .phone-prefix {
        right: auto;
        left: 10px;
      }

      html[dir="ltr"] .phone-input-wrapper input {
        padding-right: 15px;
        padding-left: 70px;
      }
    }
  </style>
<body>
  <header class="header">
    <div class="container">
      <div class="header-content">
        <div class="logo">
          <h1 data-i18n="salon_name">صالون<span data-i18n="salon_highlight"> الحلاقة</span></h1>
        </div>
        <nav class="nav">
          <ul class="nav-list">
            <li class="nav-item"><a href="#home" class="nav-link active" data-i18n="home">الرئيسية</a></li>
            <li class="nav-item"><a href="#" id="servicesNavLink" class="nav-link" data-i18n="services">الخدمات</a></li>
            <li class="nav-item"><a href="contact.html" class="nav-link" data-i18n="contact">اتصل بنا</a></li>
            <li class="nav-item">
              <a href="#" class="nav-link language-link" id="languageToggle">
                <span data-i18n="language">FR</span>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <section id="home" class="hero">
    <div class="hero-content">
      <h1 class="hero-title" data-i18n="hero_title">قصات شعر متميزة</h1>
      <p class="hero-subtitle" data-i18n="hero_subtitle">استمتع بأفضل خدمات الحلاقة</p>
      <div class="hero-buttons">
        <a href="#book" class="btn btn-primary" data-i18n="book_now">احجز الآن</a>
        <a href="#" id="servicesButton" class="btn btn-secondary" data-i18n="confirm_appointment">تأكيد الموعد</a>
      </div>
    </div>
  </section>

  <section id="book" class="booking">
    <div class="container">
      <h2 class="section-title centered" data-i18n="book_appointment_title">احجز موعدك الآن</h2>
      <div class="section-divider centered"></div>
      <p class="section-description" data-i18n="book_appointment_description">اختر التاريخ والوقت المفضل لديك للحلاقة</p>
      <div class="booking-content">
        <div class="form-group">
          <label for="date" data-i18n="choose_date">اختر التاريخ</label>
          <input type="date" id="date" name="date" class="form-control">
        </div>
        <div class="form-group">
          <label for="timePlaceholder" data-i18n="choose_time">اختر الوقت</label>
          <input type="text" id="timePlaceholder" class="form-control" readonly placeholder="اختر الوقت..." data-i18n-placeholder="choose_time_placeholder">
          <input type="hidden" id="selectedTime" name="time">
        </div>
        <div class="form-row">
          <div class="form-group half">
            <label for="firstName" data-i18n="first_name">الاسم الأول</label>
            <input type="text" id="firstName" name="firstName" class="form-control" required>
          </div>
          <div class="form-group half">
            <label for="lastName" data-i18n="last_name">اسم العائلة</label>
            <input type="text" id="lastName" name="lastName" class="form-control" required>
          </div>
        </div>
        <div class="form-group">
          <label for="phone" data-i18n="phone_number">رقم الهاتف</label>
          <div class="phone-input-wrapper">
            <div class="phone-prefix">
              <img src="https://flagcdn.com/16x12/tn.png" alt="Tunisian Flag">
              <span>+216</span>
            </div>
            <input type="tel" id="phone" name="phone" class="form-control" inputmode="numeric" pattern="[0-9]{8}" minlength="8" maxlength="8" required placeholder="" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 8)">
          </div>
          <small class="form-text" data-i18n="phone_hint">(8 أرقام فقط)</small>
        </div>
        <div class="form-group">
          <button type="button" id="bookButton" class="btn btn-primary btn-block" data-i18n="book_now_button">احجز الآن</button>
        </div>
      </div>
    </div>
  </section>

  <section id="waiting" class="waiting-list">
    <div class="container">
      <h2 class="section-title centered" data-i18n="waiting_list_title">قائمة انتظار الحجز</h2>
      <div class="section-divider centered"></div>
      <p class="section-description" data-i18n="waiting_list_description">أدخل بياناتك للانضمام إلى قائمة الانتظار</p>
      <div class="waiting-list-content">
        <div class="form-row">
          <div class="form-group half">
            <label for="waitingFirstName" data-i18n="first_name">الاسم الأول</label>
            <input type="text" id="waitingFirstName" name="waitingFirstName" class="form-control" required>
          </div>
          <div class="form-group half">
            <label for="waitingLastName" data-i18n="last_name">اسم العائلة</label>
            <input type="text" id="waitingLastName" name="waitingLastName" class="form-control" required>
          </div>
        </div>
        <div class="form-group">
          <label for="waitingPhone" data-i18n="phone_number">رقم الهاتف</label>
          <div class="phone-input-wrapper">
            <div class="phone-prefix">
              <img src="https://flagcdn.com/16x12/tn.png" alt="Tunisian Flag">
              <span>+216</span>
            </div>
            <input type="tel" id="waitingPhone" name="waitingPhone" class="form-control" inputmode="numeric" pattern="[0-9]{8}" minlength="8" maxlength="8" required placeholder="12345678" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 8)">
          </div>
          <small class="form-text" data-i18n="phone_hint">(8 أرقام فقط)</small>
        </div>
        <div class="form-group">
          <button type="button" id="joinWaitingButton" class="btn btn-primary btn-block" data-i18n="join_waitlist">انضم إلى قائمة الانتظار</button>
        </div>
      </div>
    </div>
  </section>

  <div id="servicesModal" class="modal">
    <div class="modal-content">
      <h2 data-i18n="enter_phone_title">أدخل رقم هاتفك</h2>
      <div class="form-group">
        <label for="servicesPhone" data-i18n="phone_number">رقم الهاتف</label>
        <div class="phone-input-wrapper">
          <div class="phone-prefix">
            <img src="https://flagcdn.com/16x12/tn.png" alt="Tunisian Flag">
            <span>+216</span>
          </div>
          <input type="tel" id="servicesPhone" name="servicesPhone" class="form-control" inputmode="numeric" pattern="[0-9]{8}" minlength="8" maxlength="8" required placeholder="12345678" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 8)">
        </div>
        <small class="form-text" data-i18n="phone_hint">(8 أرقام فقط)</small>
      </div>
      <button id="checkPhoneButton" data-i18n="check_phone">تحقق</button>
    </div>
  </div>

  <div id="adminLoginModal" class="modal">
    <div class="modal-content">
      <h2 data-i18n="admin_login_title">تسجيل دخول المشرف</h2>
      <div class="form-group">
        <label for="adminEmail" data-i18n="email">البريد الإلكتروني</label>
        <input type="email" id="adminEmail" name="adminEmail" class="form-control" required>
      </div>
      <div class="form-group">
        <label for="adminPassword" data-i18n="password">كلمة المرور</label>
        <input type="password" id="adminPassword" name="adminPassword" class="form-control" required>
      </div>
      <button id="adminLoginButton" data-i18n="login">تسجيل الدخول</button>
    </div>
  </div>

  <div id="timeModal" class="modal">
    <div class="modal-content time-modal-content">
      <h2 data-i18n="choose_time">اختر الوقت</h2>
      <div class="time-buttons">
        <button id="pmButton" class="period-button">PM</button>
        <button id="amButton" class="period-button">AM</button>
      </div>
      <select id="timeSelect" class="form-control"></select>
      <button id="confirmTimeButton">تأكيد</button>
    </div>
  </div>

  <div id="toast" class="toast" style="display: none;">
    <i class="fas fa-check-circle toast-icon"></i>
    <span id="toastMessage"></span>
    <button class="toast-close">×</button>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-logo">
          <h2 data-i18n="salon_name">Barberly<span data-i18n="salon_highlight"> Barberly Shop</span></h2>
        </div>
      </div>
    </div>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const translations = {
        ar: {
          "salon_name": "Barbiche",
          "salon_highlight": "Barbiche Shop",
          "home": "الرئيسية",
          "services": "الخدمات",
          "contact": "اتصل بنا",
          "book_appointment": "احجز موعد",
          "language": "FR",
          "hero_title": "قصات شعر متميزة",
          "hero_subtitle": "استمتع بأفضل خدمات الحلاقة",
          "book_now": "احجز الآن",
          "confirm_appointment": "تأكيد الموعد",
          "book_appointment_title": "احجز موعدك الآن",
          "book_appointment_description": "اختر التاريخ والوقت المفضل لديك لحلاقة مثالية",
          "choose_date": "اختر التاريخ",
          "choose_time": "اختر الوقت",
          "choose_time_placeholder": "اختر الوقت...",
          "first_name": "الاسم الأول",
          "last_name": "اسم العائلة",
          "book_now_button": "احجز الآن",
          "join_waitlist": "انضم إلى قائمة الانتظار",
          "waiting_list_title": "قائمة انتظار الحجز",
          "waiting_list_description": "أدخل بياناتك للانضمام إلى قائمة الانتظار",
          "appointment_success": "تم حجز الموعد بنجاح!",
          "fill_all_fields": "الرجاء ملء جميع الفراغات",
          "time_booked": "هذا الموعد محجوز بالفعل",
          "max_appointments": "يمكنك حجز 3 مواعيد كحد أقصى في اليوم",
          "no_working_hours": "لا توجد ساعات عمل لهذا التاريخ",
          "no_available_slots": "لا توجد مواعيد متاحة لهذا التاريخ",
          "phone_number": "رقم الهاتف",
          "phone_hint": "(8 أرقام فقط)",
          "invalid_phone": "رقم الهاتف يجب أن يكون 8 أرقام",
          "no_booking": "ليس لديك حجز حالي",
          "enter_phone_title": "أدخل رقم هاتفك",
          "check_phone": "تحقق",
          "phone_not_found": "رقم الهاتف غير موجود في قاعدة البيانات",
          "appointments_stopped": "الحجوزات متوقفة حاليًا",
          "waitlist_success": "تمت إضافتك إلى قائمة الانتظار! رقم تذكرتك: ",
          "admin_login_title": "تسجيل دخول المشرف",
          "email": "البريد الإلكتروني",
          "password": "كلمة المرور",
          "login": "تسجيل الدخول",
          "login_success": "تم تسجيل الدخول بنجاح!",
          "login_failed": "فشل تسجيل الدخول، تحقق من البريد وكلمة المرور"
        },
        fr: {
          "salon_name": "Barbiche",
          "salon_highlight": "Barbiche Shop",
          "home": "Accueil",
          "services": "Services",
          "contact": "Contact",
          "book_appointment": "Réserver",
          "language": "AR",
          "hero_title": "Coupes de cheveux exceptionnelles",
          "hero_subtitle": "Profitez des meilleurs services de coiffure",
          "book_now": "Réserver maintenant",
          "confirm_appointment": "Confirmer le rendez-vous",
          "book_appointment_title": "Réservez votre rendez-vous",
          "book_appointment_description": "Choisissez la date et l'heure pour une coupe parfaite",
          "choose_date": "Choisissez la date",
          "choose_time": "Choisissez l'heure",
          "choose_time_placeholder": "Choisissez l'heure...",
          "first_name": "Prénom",
          "last_name": "Nom de famille",
          "book_now_button": "Réserver maintenant",
          "join_waitlist": "Rejoindre la liste d'attente",
          "waiting_list_title": "Liste d'attente pour rendez-vous",
          "waiting_list_description": "Entrez vos informations pour rejoindre la liste d'attente",
          "appointment_success": "Rendez-vous réservé avec succès!",
          "fill_all_fields": "Veuillez remplir tous les champs",
          "time_booked": "Ce créneau est déjà réservé",
          "max_appointments": "Maximum 3 rendez-vous par jour",
          "no_working_hours": "Aucun horaire pour cette date",
          "no_available_slots": "Aucun rendez-vous disponible",
          "phone_number": "Numéro de téléphone",
          "phone_hint": "(8 chiffres uniquement)",
          "invalid_phone": "Le numéro doit contenir 8 chiffres",
          "no_booking": "Vous n'avez pas de réservation",
          "enter_phone_title": "Entrez votre numéro de téléphone",
          "check_phone": "Vérifier",
          "phone_not_found": "Numéro de téléphone non trouvé dans la base de données",
          "appointments_stopped": "Les réservations sont actuellement arrêtées",
          "waitlist_success": "Ajouté à la liste d'attente! Votre ticket: ",
          "admin_login_title": "Connexion administrateur",
          "email": "Email",
          "password": "Mot de passe",
          "login": "Se connecter",
          "login_success": "Connexion réussie!",
          "login_failed": "Échec de la connexion, vérifiez l'email et le mot de passe"
        }
      };

      let currentLanguage = localStorage.getItem('userLang') || 'ar';
      document.documentElement.lang = currentLanguage;
      document.documentElement.dir = currentLanguage === 'ar' ? 'rtl' : 'ltr';

      function updateLanguage() {
        document.querySelectorAll('[data-i18n]').forEach(element => {
          const key = element.getAttribute('data-i18n');
          if (translations[currentLanguage][key]) {
            element.textContent = translations[currentLanguage][key];
          }
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
          const key = element.getAttribute('data-i18n-placeholder');
          if (translations[currentLanguage][key]) {
            element.placeholder = translations[currentLanguage][key];
          }
        });
        updatePeriodButtons();
      }

      function updatePeriodButtons() {
        document.getElementById('amButton').textContent = currentLanguage === 'ar' ? 'صباحا' : 'AM';
        document.getElementById('pmButton').textContent = currentLanguage === 'ar' ? 'مساءا' : 'PM';
        document.getElementById('confirmTimeButton').textContent = currentLanguage === 'ar' ? 'تأكيد' : 'Confirm';
      }

      updateLanguage();

      document.getElementById('languageToggle').addEventListener('click', function(e) {
        e.preventDefault();
        currentLanguage = currentLanguage === 'ar' ? 'fr' : 'ar';
        localStorage.setItem('userLang', currentLanguage);
        document.documentElement.lang = currentLanguage;
        document.documentElement.dir = currentLanguage === 'ar' ? 'rtl' : 'ltr';
        updateLanguage();
        location.reload();
      });

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyD45HxgS5ZRSdC33TqpIU9x_Us1I9CKJeQ",
  authDomain: "barbuche-style.firebaseapp.com",
  databaseURL: "https://barbuche-style-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "barbuche-style",
  storageBucket: "barbuche-style.firebasestorage.app",
  messagingSenderId: "874661569616",
  appId: "1:874661569616:web:4345e6200dc4b1ad6a1d55",
  measurementId: "G-84DMZZQHHV"
};

      const app = firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
      const auth = firebase.auth();
      const appointmentsRef = database.ref('appointments');
      const workingHoursRef = database.ref('workingHours');
      const breakTimesRef = database.ref('breakTimes');
      const waitingListRef = database.ref('waitingList');

      function showToast(message, type = 'info', duration = 3000) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        const toastIcon = toast.querySelector('.toast-icon');
        
        let iconClass;
        switch(type) {
          case 'success': iconClass = 'fa-check-circle'; break;
          case 'error': iconClass = 'fa-exclamation-circle'; break;
          case 'info': iconClass = 'fa-info-circle'; break;
          default: iconClass = 'fa-info-circle';
        }
        
        toastIcon.className = `fas ${iconClass} toast-icon`;
        toast.className = `toast ${type}`;
        toastMessage.textContent = message;
        toast.style.display = 'flex';
        
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.style.display = 'none', 300);
        }, duration);
        
        document.querySelector('.toast-close').onclick = () => {
          toast.classList.remove('show');
          setTimeout(() => toast.style.display = 'none', 300);
        };
      }

      const servicesNavLink = document.getElementById('servicesNavLink');
      const adminLoginModal = document.getElementById('adminLoginModal');
      const adminLoginButton = document.getElementById('adminLoginButton');

      servicesNavLink.addEventListener('click', (e) => {
        e.preventDefault();
        adminLoginModal.style.display = 'flex';
      });

      adminLoginModal.addEventListener('click', (e) => {
        if (e.target === adminLoginModal) {
          adminLoginModal.style.display = 'none';
          document.getElementById('adminEmail').value = '';
          document.getElementById('adminPassword').value = '';
        }
      });

      adminLoginButton.addEventListener('click', async () => {
        const email = document.getElementById('adminEmail').value.trim();
        const password = document.getElementById('adminPassword').value.trim();

        if (!email || !password) {
          showToast(translations[currentLanguage]['fill_all_fields'], 'error');
          return;
        }

        try {
          adminLoginButton.disabled = true;
          adminLoginButton.textContent = currentLanguage === 'ar' ? 'جاري تسجيل الدخول...' : 'Connexion en cours...';

          await auth.signInWithEmailAndPassword(email, password);
          showToast(translations[currentLanguage]['login_success'], 'success');
          adminLoginModal.style.display = 'none';
          window.location.href = 'admin.html';
        } catch (error) {
          console.error("Login error:", error);
          showToast(translations[currentLanguage]['login_failed'], 'error');
        } finally {
          adminLoginButton.disabled = false;
          adminLoginButton.textContent = translations[currentLanguage]['login'];
          document.getElementById('adminEmail').value = '';
          document.getElementById('adminPassword').value = '';
        }
      });

      const servicesButton = document.getElementById('servicesButton');
      const servicesModal = document.getElementById('servicesModal');
      const checkPhoneButton = document.getElementById('checkPhoneButton');

      servicesButton.addEventListener('click', (e) => {
        e.preventDefault();
        servicesModal.style.display = 'flex';
      });

      servicesModal.addEventListener('click', (e) => {
        if (e.target === servicesModal) {
          servicesModal.style.display = 'none';
          document.getElementById('servicesPhone').value = '';
        }
      });

      checkPhoneButton.addEventListener('click', async () => {
        const phone = document.getElementById('servicesPhone').value.trim();

        if (!phone) {
          showToast(translations[currentLanguage]['fill_all_fields'], 'error');
          return;
        }

        const phoneRegex = /^\d{8}$/;
        if (!phoneRegex.test(phone)) {
          showToast(translations[currentLanguage]['invalid_phone'], 'error');
          return;
        }

        const fullPhone = '+216' + phone;

        try {
          checkPhoneButton.disabled = true;
          checkPhoneButton.textContent = currentLanguage === 'ar' ? 'جاري التحقق...' : 'Vérification en cours...';

          let phoneExists = false;
          const allAppointmentsSnapshot = await appointmentsRef.once('value');
          const allAppointments = allAppointmentsSnapshot.val();

          if (allAppointments) {
            for (const date in allAppointments) {
              const dateAppointments = allAppointments[date];
              for (const id in dateAppointments) {
                if (dateAppointments[id].phoneNumber === fullPhone) {
                  phoneExists = true;
                  break;
                }
              }
              if (phoneExists) break;
            }
          }

          if (phoneExists) {
            window.location.href = `confirm.html?phone=${encodeURIComponent(fullPhone)}`;
          } else {
            showToast(translations[currentLanguage]['phone_not_found'], 'error');
            servicesModal.style.display = 'none';
            document.getElementById('servicesPhone').value = '';
          }
        } catch (error) {
          console.error("Error checking phone number:", error);
          showToast(currentLanguage === 'ar' ? 'حدث خطأ أثناء التحقق' : 'Erreur lors de la vérification', 'error');
        } finally {
          checkPhoneButton.disabled = false;
          checkPhoneButton.textContent = translations[currentLanguage]['check_phone'];
        }
      });

      let today = new Date();
      let currentDate = today.toISOString().split('T')[0];
      let maxDate = new Date(today);
      maxDate.setDate(today.getDate() + 4);
      maxDate = maxDate.toISOString().split('T')[0];

      const dateInput = document.getElementById("date");
      dateInput.min = currentDate;
      dateInput.max = maxDate;
      dateInput.addEventListener('keydown', (e) => e.preventDefault());
      dateInput.addEventListener('focus', function() { this.showPicker(); });

      function generateTimeSlots() {
        const slots = [];
        for (let hour = 0; hour < 24; hour++) {
          for (let minute = 0; minute < 60; minute += 30) {
            const time = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            slots.push(time);
          }
        }
        return slots;
      }

      const allTimeSlots = generateTimeSlots();

      async function getWorkingHours(date) {
        try {
          const [workingHoursSnapshot, breakTimesSnapshot] = await Promise.all([
            workingHoursRef.child(date).once('value'),
            breakTimesRef.orderByChild('date').equalTo(date).once('value')
          ]);

          const workingHours = workingHoursSnapshot.val();
          const breakTimes = breakTimesSnapshot.val();

          return {
            workingHours,
            breakTimes: breakTimes ? Object.values(breakTimes) : []
          };
        } catch (error) {
          console.error("Error fetching working hours:", error);
          return { workingHours: null, breakTimes: [] };
        }
      }

      function convertToMinutes(timeStr) {
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours * 60 + minutes;
      }

      function filterAvailableSlots(slots, workingHours, breakTimes, appointments, selectedDate) {
        if (!workingHours) return [];

        const { workStartTime, workEndTime } = workingHours;
        const todayStr = today.toISOString().split('T')[0];
        const currentTimeInMinutes = today.getHours() * 60 + today.getMinutes();
        const startTime = selectedDate === todayStr 
          ? Math.max(convertToMinutes(workStartTime), currentTimeInMinutes + 15)
          : convertToMinutes(workStartTime);
        const endTime = convertToMinutes(workEndTime);

        let availableSlots = slots.filter(slot => {
          const slotTime = convertToMinutes(slot);
          return slotTime >= startTime && slotTime <= endTime;
        });

        breakTimes.forEach(breakTime => {
          const breakStart = convertToMinutes(breakTime.breakStartTime);
          const breakEnd = convertToMinutes(breakTime.breakEndTime);
          availableSlots = availableSlots.filter(slot => {
            const slotTime = convertToMinutes(slot);
            return slotTime < breakStart || slotTime >= breakEnd;
          });
        });

        if (appointments) {
          Object.values(appointments).forEach(appointment => {
            const time = appointment.appointmentTime;
            availableSlots = availableSlots.filter(slot => slot !== time);
          });
        }

        return availableSlots;
      }

      function formatTime(time) {
        const [hour, minute] = time.split(':').map(Number);
        if (hour === 0 && minute === 0) {
          return '00:00';
        }
        const period = currentLanguage === 'ar' ? (hour >= 12 ? 'مساءا' : 'صباحا') : (hour >= 12 ? 'PM' : 'AM');
        const displayHour = hour === 0 ? 12 : (hour > 12 ? hour - 12 : hour);
        return `${displayHour}:${minute.toString().padStart(2, '0')} ${period}`;
      }

      let availableSlots = [];
      async function populateTimeSelect(period) {
        const timeSelect = document.getElementById("timeSelect");
        timeSelect.innerHTML = '<option value="">--</option>';

        const amSlots = availableSlots.filter(slot => convertToMinutes(slot) < 12 * 60 || slot === '00:00');
        const pmSlots = availableSlots.filter(slot => convertToMinutes(slot) >= 12 * 60 && slot !== '00:00');
        const slotsToShow = period === 'AM' ? amSlots : pmSlots;

        slotsToShow.forEach(slot => {
          const option = document.createElement("option");
          option.value = slot;
          option.textContent = formatTime(slot);
          timeSelect.appendChild(option);
        });
      }

      async function displayAvailableSlots(date) {
        try {
          const appointmentsSnapshot = await appointmentsRef.child(date).once('value');
          const appointments = appointmentsSnapshot.val();
          const { workingHours, breakTimes } = await getWorkingHours(date);

          if (!workingHours) {
            showToast(translations[currentLanguage]['no_working_hours'], 'error');
            return;
          }

          availableSlots = filterAvailableSlots(allTimeSlots, workingHours, breakTimes, appointments, date);
          if (availableSlots.length === 0) {
            showToast(translations[currentLanguage]['no_available_slots'], 'info');
          }
          populateTimeSelect('AM');
        } catch (error) {
          console.error("Error displaying slots:", error);
          showToast(currentLanguage === 'ar' ? 'خطأ في جلب المواعيد' : 'Erreur lors du chargement', 'error');
        }
      }

      dateInput.addEventListener("change", (event) => {
        const selectedDate = event.target.value;
        if (selectedDate) displayAvailableSlots(selectedDate);
      });

      const timePlaceholder = document.getElementById('timePlaceholder');
      const timeModal = document.getElementById('timeModal');
      const amButton = document.getElementById('amButton');
      const pmButton = document.getElementById('pmButton');
      const confirmTimeButton = document.getElementById('confirmTimeButton');

      timePlaceholder.addEventListener('click', () => {
        if (!dateInput.value) {
          showToast(currentLanguage === 'ar' ? 'اختر التاريخ أولاً' : 'Choose a date first', 'error');
          return;
        }
        timeModal.style.display = 'flex';
        amButton.classList.remove('selected');
        pmButton.classList.remove('selected');
        populateTimeSelect('AM');
      });

      timeModal.addEventListener('click', (e) => {
        if (e.target === timeModal) {
          timeModal.style.display = 'none';
        }
      });

      amButton.addEventListener('click', () => {
        amButton.classList.add('selected');
        pmButton.classList.remove('selected');
        populateTimeSelect('AM');
      });

      pmButton.addEventListener('click', () => {
        pmButton.classList.add('selected');
        amButton.classList.remove('selected');
        populateTimeSelect('PM');
      });

      confirmTimeButton.addEventListener('click', () => {
        const timeSelect = document.getElementById('timeSelect');
        const selectedTime = timeSelect.value;
        if (selectedTime) {
          timePlaceholder.value = formatTime(selectedTime);
          document.getElementById('selectedTime').value = selectedTime;
          timeModal.style.display = 'none';
        } else {
          showToast(currentLanguage === 'ar' ? 'اختر وقتاً' : 'Choose a time', 'error');
        }
      });

      function clearForm(section) {
        if (section === 'booking') {
          dateInput.value = '';
          timePlaceholder.value = '';
          document.getElementById('selectedTime').value = '';
          document.getElementById('firstName').value = '';
          document.getElementById('lastName').value = '';
          document.getElementById('phone').value = '';
        } else if (section === 'waiting') {
          document.getElementById('waitingFirstName').value = '';
          document.getElementById('waitingLastName').value = '';
          document.getElementById('waitingPhone').value = '';
        }
      }

      const bookButton = document.getElementById("bookButton");
      const joinWaitingButton = document.getElementById("joinWaitingButton");
      const bookingSection = document.getElementById("book");
      const waitingSection = document.getElementById("waiting");

      async function checkAppointmentsStatus() {
        const snapshot = await database.ref('settings/allowAppointments').once('value');
        const allowAppointments = snapshot.val() !== false;
        bookingSection.style.display = allowAppointments ? 'block' : 'none';
        waitingSection.style.display = allowAppointments ? 'none' : 'block';
      }
      checkAppointmentsStatus();
      database.ref('settings/allowAppointments').on('value', checkAppointmentsStatus);

      bookButton.addEventListener("click", async () => {
        const allowAppointmentsSnapshot = await database.ref('settings/allowAppointments').once('value');
        const allowAppointments = allowAppointmentsSnapshot.val() !== false;

        if (!allowAppointments) {
          showToast(translations[currentLanguage]['appointments_stopped'], 'error');
          return;
        }

        const selectedDate = dateInput.value;
        const selectedTime = document.getElementById("selectedTime").value;
        const firstName = document.getElementById("firstName").value.trim();
        const lastName = document.getElementById("lastName").value.trim();
        const phone = document.getElementById("phone").value.trim();

        if (!selectedDate || !selectedTime || !firstName || !lastName || !phone) {
          showToast(translations[currentLanguage]['fill_all_fields'], 'error');
          return;
        }

        const phoneRegex = /^\d{8}$/;
        if (!phoneRegex.test(phone)) {
          showToast(translations[currentLanguage]['invalid_phone'], 'error');
          return;
        }

        const fullPhone = '+216' + phone;

        try {
          bookButton.disabled = true;
          bookButton.textContent = currentLanguage === 'ar' ? 'جاري الحجز...' : 'Réservation en cours...';

          const appointmentsSnapshot = await appointmentsRef.child(selectedDate).once('value');
          const appointments = appointmentsSnapshot.val();

          if (appointments && Object.values(appointments).some(apt => apt.appointmentTime === selectedTime)) {
            showToast(translations[currentLanguage]['time_booked'], 'error');
            return;
          }

          const userAppointments = appointments ? Object.values(appointments).filter(apt => apt.phoneNumber === fullPhone).length : 0;
          if (userAppointments >= 3) {
            showToast(translations[currentLanguage]['max_appointments'], 'error');
            return;
          }

          const newAppointmentRef = appointmentsRef.child(selectedDate).push();
          const appointmentData = {
            fullName: `${firstName} ${lastName}`,
            phoneNumber: fullPhone,
            appointmentTime: selectedTime,
            status: "reserved",
            fromWaitingList: false,
            timestamp: firebase.database.ServerValue.TIMESTAMP
          };

          await newAppointmentRef.set(appointmentData);
          showToast(translations[currentLanguage]['appointment_success'], 'success');
          clearForm('booking');
          window.location.href = `confirm.html?phone=${encodeURIComponent(fullPhone)}`;
        } catch (error) {
          console.error("Error booking appointment:", error);
          showToast(currentLanguage === 'ar' ? 'حدث خطأ أثناء الحجز' : 'Erreur lors de la réservation', 'error');
        } finally {
          bookButton.disabled = false;
          bookButton.textContent = translations[currentLanguage]['book_now_button'];
        }
      });

      joinWaitingButton.addEventListener("click", async () => {
        const firstName = document.getElementById("waitingFirstName").value.trim();
        const lastName = document.getElementById("waitingLastName").value.trim();
        const phone = document.getElementById("waitingPhone").value.trim();

        if (!firstName || !lastName || !phone) {
          showToast(translations[currentLanguage]['fill_all_fields'], 'error');
          return;
        }

        const phoneRegex = /^\d{8}$/;
        if (!phoneRegex.test(phone)) {
          showToast(translations[currentLanguage]['invalid_phone'], 'error');
          return;
        }

        const fullPhone = '+216' + phone;

        try {
          joinWaitingButton.disabled = true;
          joinWaitingButton.textContent = currentLanguage === 'ar' ? 'جاري الإضافة...' : 'Ajout en cours...';

          const waitlistSnapshot = await waitingListRef.once('value');
          const waitlist = waitlistSnapshot.val() || {};
          const ticketNumber = Object.keys(waitlist).length + 1;

          await waitingListRef.push({
            fullName: `${firstName} ${lastName}`,
            phoneNumber: fullPhone,
            ticketNumber: ticketNumber,
            timestamp: firebase.database.ServerValue.TIMESTAMP
          });

          showToast(`${translations[currentLanguage]['waitlist_success']} ${ticketNumber}`, 'success');
          clearForm('waiting');
        } catch (error) {
          console.error("Error adding to waitlist:", error);
          showToast(currentLanguage === 'ar' ? 'حدث خطأ أثناء الإضافة' : 'Erreur lors de l’ajout', 'error');
        } finally {
          joinWaitingButton.disabled = false;
          joinWaitingButton.textContent = translations[currentLanguage]['join_waitlist'];
        }
      });

      function getClosestSlotWithBuffer(currentTimeInMinutes, availableSlots, workingHours) {
        const buffer = 30; // 30-minute buffer
        const minTime = currentTimeInMinutes + buffer;
        const endTime = convertToMinutes(workingHours.workEndTime);

        for (let slot of availableSlots) {
          const slotTime = convertToMinutes(slot);
          if (slotTime >= minTime && slotTime <= endTime) {
            return slot;
          }
        }
        return null;
      }

      let previousAllowAppointments = null;
      database.ref('settings/allowAppointments').on('value', async (snapshot) => {
        const allowAppointments = snapshot.val() !== false;

        if (previousAllowAppointments === false && allowAppointments === true) {
          try {
            const waitlistSnapshot = await waitingListRef.once('value');
            const waitlist = waitlistSnapshot.val();
            if (!waitlist) return;

            const currentTime = new Date();
            const currentDateStr = currentTime.toISOString().split('T')[0];
            const currentTimeInMinutes = currentTime.getHours() * 60 + currentTime.getMinutes();

            const appointmentsSnapshot = await appointmentsRef.child(currentDateStr).once('value');
            const appointments = appointmentsSnapshot.val() || {};
            const { workingHours, breakTimes } = await getWorkingHours(currentDateStr);

            if (!workingHours) {
              console.log("No working hours defined for today");
              showToast(translations[currentLanguage]['no_working_hours'], 'error');
              return;
            }

            const availableSlots = filterAvailableSlots(allTimeSlots, workingHours, breakTimes, appointments, currentDateStr);
            if (availableSlots.length === 0) {
              console.log("No available slots for waitlist users");
              showToast(translations[currentLanguage]['no_available_slots'], 'info');
              return;
            }

            const sortedWaitlist = Object.entries(waitlist).sort((a, b) => a[1].ticketNumber - b[1].ticketNumber);
            const updates = {};
            const usedSlots = new Set(Object.values(appointments).map(apt => apt.appointmentTime));

            for (const [id, user] of sortedWaitlist) {
              const closestSlot = getClosestSlotWithBuffer(currentTimeInMinutes, availableSlots.filter(slot => !usedSlots.has(slot)), workingHours);
              if (closestSlot) {
                const appointmentData = {
                  fullName: user.fullName,
                  phoneNumber: user.phoneNumber,
                  appointmentTime: closestSlot,
                  status: "pending",
                  fromWaitingList: true,
                  originalTicketNumber: user.ticketNumber,
                  timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                const newKey = appointmentsRef.child(currentDateStr).push().key;
                updates[`appointments/${currentDateStr}/${newKey}`] = appointmentData;
                updates[`waitingList/${id}`] = null;
                usedSlots.add(closestSlot);
              } else {
                console.log(`No valid slot found for ${user.fullName} after applying 30-minute buffer`);
              }
            }

            if (Object.keys(updates).length > 0) {
              await database.ref().update(updates);
              console.log(`Moved ${Object.keys(updates).length / 2} users from waitingList to appointments/${currentDateStr}`);
              showToast(translations[currentLanguage]['waitlist_success'], 'success');
            } else {
              console.log("No slots available after filtering with buffer");
              showToast(translations[currentLanguage]['no_available_slots'], 'info');
            }
          } catch (error) {
            console.error("Error moving waitlist users:", error);
            showToast(currentLanguage === 'ar' ? 'حدث خطأ أثناء نقل قائمة الانتظار' : 'Erreur lors du déplacement de la liste d’attente', 'error');
          }
        }
        previousAllowAppointments = allowAppointments;
      });
    });
  </script>
</body>
</html>
